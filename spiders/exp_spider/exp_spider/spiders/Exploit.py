import time

import requests
import scrapy
import datetime
from exp_spider.items import ExpSpiderItem
from bs4 import BeautifulSoup

class ExploitSpider(scrapy.Spider):
    name = "exploit"

    def start_requests(self):
        urls = []
        # # 获取昨日新增
        # today = datetime.date.today()
        # oneday = datetime.timedelta(days=1)
        # yesterday = today - oneday
        # # 得到昨日新增 URL
        # # ***********************************************
        # res = requests.get(base_url)
        # items = []
        # for item in items:
        #     if '获取日期' == str(yesterday):
        #         urls.append('')
        # # ***********************************************
        for i in range(50500,50500):
            urls.append('https://www.exploit-db.com/exploits/'+str(i))
            print('https://www.exploit-db.com/exploits/'+str(i))
        for url in urls:
            yield scrapy.Request(url=url, callback=self.parse)

    def parse(self, response):
        # time.sleep(2)
        exp = ExpSpiderItem()
        soup = BeautifulSoup(response.text, features="lxml")
        exp['title'] = soup.title.string
        # print(exp['title'])
        if exp['title'] == '404 Page Not Found | Exploit Database':
            pass
        for div in soup.find_all('div', class_='col-sm-12 col-md-6 col-lg-3 d-flex align-items-stretch'):
            for h in div.find_all('div', class_='col-6 text-center'):
                if h.h4.get_text().strip() == 'EDB-ID:':
                    exp['edb_id'] = h.h6.get_text().strip()
                if h.h4.get_text().strip() == 'CVE:':
                    exp['cve'] = h.h6.get_text().strip()
                if h.h4.get_text().strip() == 'Author:':
                    exp['author'] = h.h6.get_text().strip()
                if h.h4.get_text().strip() == 'Type:':
                    exp['type'] = h.h6.get_text().strip()
                if h.h4.get_text().strip() == 'Platform:':
                    exp['plat'] = h.h6.get_text().strip()
                if h.h4.get_text().strip() == 'Date:':
                    exp['date'] = h.h6.get_text().strip()
            for s in div.find_all('div', class_='stats h5 text-center'):
                if s.strong.string.strip() == 'EDB Verified:':
                    if s.i['class'] == ['mdi', 'mdi-24px', 'mdi-check']:
                        exp['verified'] = 'Yes'
                    else:
                        exp['verified'] = 'No'
                elif s.strong.string.strip() == 'Exploit:':
                    exp['code_url'] = 'https://www.exploit-db.com' + s.a['href']
                else:
                    if s.find('a'):
                        exp['app'] = 'https://www.exploit-db.com/exploits/' + s.a['href']
        exp['code'] = soup.find('code').get_text()
        return exp