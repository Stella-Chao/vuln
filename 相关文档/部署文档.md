

### 一、环境依赖 

- Java 8

- maven

- Python 3.8.8

- MongoDB 5.0.2

- npm
- yarn
- neo4j

### 二、项目结构

- script：python 项目
  - spider：爬虫相关
    - cve.py：CVE 爬虫
    - cve_detail.py：CVE 爬虫
    - exploit_spider.py：Exploit-DB 爬虫
    - github_spider.py：GitHub 爬虫
    - hardware_products.py：硬件产品爬虫
    - jvn_spider.py：JVN 爬虫
    - qly_spider.py：青莲云爬虫
    - spider_utils.py：爬虫工具集合
    - vuln_fusion.py：漏洞融合
  - utils：数据处理脚本
  - config.py：配置 MongoDB 的用户名密码
- backend2：后端
- frontend3：前端
- dashboard：数据大屏
- model：相关模型



### 三、MongoDB

> 新建以下集合（类比 MySQL 中的表）

| Collection | 注释              |
| ---------- | ----------------- |
| cve        | CVE               |
| data01     | Test              |
| device     | 设备信息          |
| exploit    | Exploit-DB（Poc） |
| github     | GitHub（Poc）     |
| iot        | IoT 漏洞          |
| iot2       | IoT 漏洞          |
| iot3       | IoT 漏洞          |
| jvndb      | JVNDB 漏洞        |
| jvndb2     | JVNDB 漏洞        |
| nvd        | NVD 漏洞          |
| nvd01      | NVD 漏洞          |
| submit_iot | 提交漏洞          |
| subscribe  | 漏洞订阅          |
| total      | 漏洞融合汇总      |
| user       | 用户信息          |

> 运行 mongoexport -h localhost:27017 -u 'db_name' -p 'password' -d [db] -c [collection] -o a.json 可导出数据库集合到json





### 四、启动过程

##### 1.后端启动

```bash
$ mvn package
$ java -jar ***.jar
```



##### 2.前端启动

进入 frontend3 路径，两种方式启动：

yarn

```bash
$ yarn install
$ yarn serve
```
npm

```bash
$ npm install
$ npm run serve
```

##### 3.监控大屏

进入 dashboard 路径

```bash
$ yarn install
$ yarn run dev
```



### 五、爬虫模块

数据源：CVE、JVNDB、Exploit-DB、GitHub

数据爬取

1. 先运行一次 **.py 获取全量的数据（漏洞、PoC）
2. 设置定时任务运行 **.py 获取增量数据
3. 设置定时任务运行 **.py 融合多源数据（cve + jvn） => 通知管理员
4. 管理员在系统核实后 => 邮件推送订阅者 

##### 1.获取全量数据

**JVNDB**

> 经尝试直接爬取 + IP 代理的效果不佳，这里用 Scrapy-Redis 框架爬取

配置说明：

jvn_spider/settings.py 中修改 Redis 配置

```python
REDIS_HOST = '***.***.***.***'
REDIS_PORT = 6379
REDIS_ENCODING = 'utf-8'
REDIS_PARAMS = {
    'password': '******',
}
```

jvn_spider/spiders/jvn.py 中

```python
def start_requests(self):
    base = 'https://jvndb.jvn.jp/'
    search_base = 'https://jvndb.jvn.jp/search/index.php?		   mode=_vulnerability_search_IA_VulnSearch&lang=ja&keyword=&useSynonym=1&vendor=&product=&datePublicFromYear={}&datePublicFromMonth={}&datePublicToYear={}&datePublicToMonth={}&dateLastPublishedFromMonth=&dateLastPublishedFromYear=&dateLastPublishedToMonth=&dateLastPublishedToYear=&cwe=&searchProductId=&pageNo={}'
    from_year = "2000"
    from_month = "06"
    to_year = "2001"
    to_month = "10"
```

每次只能获取小于 10000 条数据，所以，from_year、from_month、to_year、to_month 需要多次修改

**CVE**

> 通过 API 的方式

执行 script/spider/cve.py 中的 get_all_cve() 方法

##### 2.获取增量数据

> 爬取当天新增的漏洞，定时任务

***.py

##### 3.数据融合

> 从各个集合中按日期查找出当日新增的记录，融合后放入新的集合
>
> 注意：有些是新增的漏洞，有些是新更新的漏洞

***.py

##### 4.邮件通知

> 获取订阅者列表 -> 发送当日新增漏洞

***.py

### 六、注意事项

##### 1.MongoDB 的配置需要修改:

backend2 中修改 /backend2/src/main/resources/application.yml

```yaml
server:
  port: 9090
  data:
    mongodb:
      # 此处需要修改
      uri: mongodb://zh:zhanghe@127.0.0.1:27017/vuln
    option:
    neo4j:
      database: tfsec

  neo4j:
    uri: bolt://localhost:7687
    authentication:
      username: neo4j
      password: test

mybatis:
  mapper-locations: classpath:mapper/*Mapper.xml
```



/script/config.py

```python
MONGO_HOST = '127.0.0.1'
# vuln
MONGO_USER = '****'
MONGO_PASSWORD = '****'
```

